# PSM双资源池部署分析工具

## 功能介绍

本工具用于分析PSM（Product Service Module）服务在两个不同资源池中的部署情况，帮助用户找到可以从第一个资源池腾挪资源并在第二个资源池补充实例的PSM服务。主要功能包括：

1. 按机房（IDC）过滤数据
2. 查找同时部署在两个指定资源池中的PSM服务
3. 按第一个资源池（需借出）的实例数从大到小排序
4. 计算资源使用汇总（实例数、CPU、内存）
5. 提供Web界面进行可视化分析和交互
6. 支持表格筛选、排序和导出功能

## 使用方法

### 前提条件

- Python 3.x
- pandas 库
- openpyxl 库
- Flask 库
- 数据源Excel文件（默认为`all.xlsx`）

### 安装依赖

```bash
pip install -r requirements.txt
```

### 运行方式

#### 命令行模式

```bash
python main.py
```

#### Web应用模式

```bash
python app.py
```

启动后，在浏览器中访问：http://localhost:5000

### 交互流程

#### 命令行模式

1. 输入要过滤的机房名称（可选）
   - 多个机房用逗号分隔
   - 留空表示不过滤机房

2. 输入第一个资源池信息（需借出资源的集群）
   - 格式：`Physical Cluster/IaaS Cluster`
   - 例如：`Oscar/default`

3. 输入第二个资源池信息（可补充资源的集群）
   - 格式：`Physical Cluster/IaaS Cluster`
   - 例如：`Zelda/default`

4. 输入输出文件名（可选）
   - 默认为`dual_deployment_analysis.xlsx`
   - 无需添加`.xlsx`后缀，程序会自动添加

#### Web应用模式

1. 在浏览器中访问应用首页
2. 填写表单：
   - 机房名称（可选）
   - 第一个资源池（需借出）
   - 第二个资源池（可补充）
3. 点击"开始分析"按钮
4. 查看分析结果：
   - 详细数据表格（支持筛选、排序和导出）
   - 资源汇总表格（支持筛选、排序和导出）
   - 统计信息
5. 可下载Excel文件保存结果

## 输出结果

程序会生成一个Excel文件，包含以下工作表：

1. **详细数据**：包含所有同时部署在两个资源池的PSM服务详细信息
   - 按第一个资源池（需借出）的实例数从大到小排序
   - 同一PSM服务在两个资源池的数据相邻显示
   - 包含PSM、资源池标识、物理集群、IaaS集群、实例数、CPU限制、内存限制等信息

2. **资源汇总**：按PSM和资源池分组的资源使用汇总
   - 包含实例数、CPU核数、内存总量
   - 与详细数据保持相同的排序

3. **统计信息**：整体统计数据
   - 两个资源池的标识（需借出和可补充）
   - PSM总数量
   - 总实例数
   - 总CPU核数
   - 总内存GB

## Web应用功能

### 表格筛选和排序

- 每个表格列头支持点击排序（升序/降序）
- 表格右上角提供搜索框，可进行全局搜索
- 可调整每页显示的记录数量
- 支持分页浏览

### 数据导出

- 支持将表格数据导出为Excel、CSV、复制到剪贴板或打印
- 可下载完整的Excel分析报告

### 可视化增强

- 不同资源池的数据使用不同颜色标识：
  - 第一个资源池（需借出）：黄色背景
  - 第二个资源池（可补充）：绿色背景
- 鼠标悬停时高亮显示同一PSM的所有行

## 执行逻辑

1. **数据加载**：从Excel文件加载原始数据

2. **数据过滤**：
   - 按用户指定的机房列表过滤（如有）
   - 过滤出`cluster_name`为`default`的数据

3. **资源池解析**：
   - 将用户输入的资源池字符串解析为物理集群和IaaS集群
   - 创建资源池标识符

4. **PSM分析**：
   - 查找同时存在于两个指定资源池的PSM服务
   - 只保留这些PSM在指定两个资源池中的数据

5. **数据处理**：
   - 确保数值字段（实例数、CPU、内存）为数值类型
   - 按第一个资源池（需借出）的实例数从大到小排序
   - 将同一PSM在两个资源池的数据相邻排列

6. **汇总计算**：
   - 按PSM和资源池分组计算资源使用汇总
   - 计算总体统计信息

7. **结果输出**：
   - 将详细数据、汇总数据和统计信息保存到Excel文件的不同工作表
   - 在Web模式下，同时在浏览器中展示结果

## 资源腾挪分析

本工具特别适用于资源腾挪分析场景：

1. **第一个资源池**是需要借出资源的集群，通常是资源紧张需要腾挪的集群
2. **第二个资源池**是可以补充资源的集群，可以接收从第一个集群迁移的服务实例

通过按第一个资源池的实例数从大到小排序，用户可以快速找到：
- 在第一个资源池中占用较多资源的服务
- 同时这些服务在第二个资源池也有部署，可以考虑将其从第一个资源池迁移到第二个资源池

这种分析有助于优化资源分配，缓解资源紧张的集群压力。

## 项目结构

```
/
├── main.py              # 命令行版本主程序
├── app.py               # Web应用主程序
├── requirements.txt     # 依赖包列表
├── all.xlsx             # 数据源文件
├── README.md            # 说明文档
├── static/              # 静态资源目录
│   ├── css/             # CSS样式文件
│   │   └── style.css    # 自定义样式
│   └── js/              # JavaScript文件
│       └── main.js      # 前端交互脚本
└── templates/           # HTML模板目录
    ├── index.html       # 首页模板
    ├── results.html     # 结果页模板
    └── error.html       # 错误页模板
```

## 注意事项

1. 输入的资源池必须使用`Physical Cluster/IaaS Cluster`格式
2. 程序会自动处理Excel中字符类型的数值字段，确保正确排序
3. 如果找不到同时部署在两个资源池的PSM，程序会提示并退出
4. 数据源Excel文件路径默认为`/Applications/code_repoistory/tengnuo/all.xlsx`，可在代码中修改
5. Web应用默认在5000端口运行，可在`app.py`中修改

## 错误处理

程序包含以下错误处理机制：

1. Excel文件加载失败时会显示错误信息并退出
2. 资源池格式错误时会提示正确格式
3. 数值转换失败时会显示警告并使用默认值
4. 其他异常会显示详细的错误信息和堆栈跟踪
5. Web应用中的错误会在专门的错误页面中显示